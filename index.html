<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Assistente ConcordatoFacile</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='10 0 100 100'><text y='.9em' font-size='90'>ü§ñ</text></svg>">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- Import font "Inter" -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        /* --- Modern Light Theme Variables --- */
        :root {
          /* Core Palette */
          --bg-color: #ffffff;
          --text-color: #333333;
          --input-bg-color: #f5f5f5;
          --border-color: #dddddd;

          /* Accent Palette */
          --prompt-color: #0066cc;
          --user-prefix-color: var(--prompt-color);
          --assistant-color: #cc0066;
          --system-color: #666666;
          --command-color: #0066cc;
          --error-color: #d93025;
          --highlight-color: #0066cc;
          --scrollbar-thumb-color: #cccccc;
          --scrollbar-track-color: var(--input-bg-color);

          /* Typography */
          --font-family: 'Inter', sans-serif;
          --font-size-base: 16px;
          --font-size-mobile: 15px;
          --line-height: 1.6;

          /* Spacing */
          --padding-base: 15px;
          --padding-mobile: 10px;
        }
        *, *::before, *::after { box-sizing: border-box; }
        html { font-size: var(--font-size-base); }
        body {
          background-color: var(--bg-color);
          color: var(--text-color);
          font-family: var(--font-family);
          margin: 0; padding: 0;
          display: flex; flex-direction: column;
          height: 100dvh; overflow: hidden;
        }
        main#terminal {
          flex-grow: 1;
          padding: var(--padding-base) var(--padding-base) 65px var(--padding-base);
          overflow-y: auto;
          white-space: pre-wrap; word-wrap: break-word;
          line-height: var(--line-height);
          -webkit-font-smoothing: antialiased;
          -moz-osx-font-smoothing: grayscale;
        }
        /* Scrollbar */
        main#terminal::-webkit-scrollbar { width: 10px; }
        main#terminal::-webkit-scrollbar-track { background: var(--scrollbar-track-color); }
        main#terminal::-webkit-scrollbar-thumb { background-color: var(--scrollbar-thumb-color); border-radius: 5px; border: 2px solid var(--scrollbar-track-color); }
        main#terminal::-webkit-scrollbar-thumb:hover { background-color: #aaaaaa; }
        main#terminal { scrollbar-width: thin; scrollbar-color: var(--scrollbar-thumb-color) var(--scrollbar-track-color); }
        footer#inputArea {
          display: flex; align-items: stretch;
          background-color: var(--input-bg-color);
          padding: calc(var(--padding-base)/2) var(--padding-base);
          border-top: 1px solid var(--border-color);
        }
        #tokenCounter {
          position: fixed; bottom: 70px; right: 20px;
          background-color: rgba(245,245,245,0.85);
          color: var(--text-color);
          padding: 5px 10px;
          border: 1px solid var(--border-color);
          border-radius: 5px;
          font-family: var(--font-family);
          font-size: 14px;
          backdrop-filter: blur(2px);
          transition: bottom 0.2s ease-out;
        }
        .message { margin-bottom: calc(var(--padding-base)*0.75); display: flex; flex-direction: column; align-items: flex-start; padding: calc(var(--padding-base)/1.5); border-radius: 8px; }
        .prefix { font-weight: bold; margin-bottom: 0.25em; user-select: none; white-space: pre; }
        .content { flex-grow: 1; }
        .user .prefix { color: var(--user-prefix-color); }
        .assistant .prefix { color: var(--assistant-color); }
        .system .prefix { color: var(--system-color); }
        .error .prefix { color: var(--error-color); }
        .message.user { background-color: rgba(0,102,204,0.05); }
        .message.assistant { background-color: rgba(204,0,102,0.05); }
        .message.system { background-color: rgba(102,102,102,0.05); }
        .message.error { background-color: rgba(217,48,37,0.05); }
        #prompt { color: var(--prompt-color); margin-right: 0.5em; font-weight: bold; padding-top: 8px; user-select: none; }
        #userInput { flex-grow: 1; background: transparent; border: none; outline: none; color: var(--text-color); font-family: var(--font-family); font-size: inherit; line-height: var(--line-height); padding: calc(var(--padding-base)/3) 0; caret-color: var(--prompt-color); resize: none; overflow-y: hidden; min-height: calc(var(--line-height)*1em + (var(--padding-base)/3)*2); }
        #userInput::placeholder { color: #999; font-style: italic; }
        .floatingToggle { position: fixed; bottom: 70px; left: 20px; background-color: rgba(245,245,245,0.85); color: var(--text-color); padding: 5px 10px; border: 1px solid var(--border-color); border-radius: 5px; font-family: var(--font-family); font-size: 14px; backdrop-filter: blur(2px); cursor: pointer; user-select: none; }
        .copy-btn { position: absolute; top: 4px; right: 4px; border: none; background: transparent; color: var(--highlight-color); font-family: var(--font-family); font-size: 0.8em; cursor: pointer; opacity: 0; transition: opacity 0.15s ease-in; }
        .message:hover .copy-btn { opacity: 0.8; }
        .message system.help-output .content a { color: var(--assistant-color); text-decoration: underline; }
        @media (max-width:600px) {
          html { font-size: var(--font-size-mobile); }
          main#terminal { padding: var(--padding-mobile) var(--padding-mobile) 60px var(--padding-mobile); }
          footer#inputArea { padding: calc(var(--padding-mobile)/1.5) var(--padding-mobile); }
          #prompt { padding-top: 6px; }
          #userInput { min-height: calc(var(--line-height)*1em + var(--padding-mobile)); }
          main#terminal::-webkit-scrollbar { width: 6px; }
          #tokenCounter { bottom: 60px; right: 15px; font-size: 13px; }
          .floatingToggle { bottom: 60px; left: 15px; font-size: 13px; }
        }
    </style>
</head>
<body>
    <main id="terminal"></main>
    <div id="tokenCounter">Token: 0</div>
    <div id="scrollToggle" class="floatingToggle">üîΩ Scorrimento automatico: ON</div>
    <footer id="inputArea">
        <span id="prompt">></span>
        <textarea id="userInput" rows="1" placeholder="Inizializzazione in corso..." autofocus autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" disabled></textarea>
    </footer>

    <script>
        const WORKER_URL = "https://germabyte-assistente-80.deno.dev/";
        const COMMAND_INFO = [
          { name: "help", desc: "help   - Visualizza questo messaggio di aiuto." },
          { name: "reset", desc: "reset  - Ripristina il contesto della chat." },
          { name: "imposta modalit√†", desc: "imposta modalit√† <nome> - Cambia modalit√† AI (reimposta contesto)." },
          { name: "stop", desc: "stop   - Interrompe la risposta corrente dell'AI." }
        ];
        const terminalDiv = document.getElementById("terminal");
        const userInput = document.getElementById("userInput");
        const tokenCounterDiv = document.getElementById("tokenCounter");
        let autoScrollEnabled = true;
        const scrollToggleDiv = document.getElementById("scrollToggle");
        scrollToggleDiv.addEventListener("click", () => {
          autoScrollEnabled = !autoScrollEnabled;
          scrollToggleDiv.textContent = autoScrollEnabled
            ? "üîΩ Scorrimento automatico: ON"
            : "‚è∏Ô∏è Scorrimento automatico: OFF";
        });
        const promptSpan = document.getElementById("prompt");
        const appState = {
            conversation: [], commandHistory: [], historyIndex: -1,
            isWaitingForAI: false, currentCharacter: null, currentModel: null,
            availableCharacters: [], currentTokenCount: 0,
            currentTokenLimit: null, thinkingIntervalId: null,
            timerIntervalId: null, thinkingStartTime: null,
            abortController: null, loadingMsgDiv: null
        };
        function formatTokenCount(num) {
            if (num === undefined || num === null) return '?';
            if (num < 1000) return num.toString();
            return (num/1000).toFixed(1).replace(/\.0$/,'')+"k";
        }
        function appendMessage(role, text, isLoading=false, extraClass=null, overridePrefix=null) {
            const msgDiv = document.createElement("div"); msgDiv.classList.add("message", role);
            if(extraClass) msgDiv.classList.add(extraClass);
            const prefixSpan = document.createElement("span"); prefixSpan.classList.add("prefix");
            const contentSpan = document.createElement("span"); contentSpan.classList.add("content");
            switch(role) {
                case 'user': prefixSpan.textContent = "UTENTE:"; contentSpan.textContent = text; break;
                case 'assistant': prefixSpan.textContent = overridePrefix ?? `\${(appState.currentCharacter||'AI').toUpperCase()}:`; if(isLoading){contentSpan.classList.add("loading-content"); contentSpan.innerHTML = `<span class="thinking-dots-span">Pensando.</span><span class="thinking-timer-span">(0.0s)</span>`;} else contentSpan.textContent = text; break;
                case 'system': prefixSpan.textContent = "SIS:"; contentSpan.textContent = text; break;
                case 'error': prefixSpan.textContent = "ERR!"; contentSpan.textContent = text; break;
                default: prefixSpan.textContent = "???:"; contentSpan.textContent = text;
            }
            msgDiv.appendChild(prefixSpan); msgDiv.appendChild(contentSpan);
            const copyBtn = document.createElement("button"); copyBtn.classList.add("copy-btn"); copyBtn.setAttribute("title","Copia questo messaggio"); copyBtn.textContent="Clicca qui per copiare";
            copyBtn.addEventListener("click",e=>{e.stopPropagation();navigator.clipboard.writeText(contentSpan.textContent||"").then(()=>{copyBtn.textContent="Copiato!";setTimeout(()=>copyBtn.textContent="Clicca qui per copiare",1500)}).catch(()=>{copyBtn.textContent="Errore copia";setTimeout(()=>copyBtn.textContent="Clicca qui per copiare",1500)});});
            msgDiv.appendChild(copyBtn);
            terminalDiv.appendChild(msgDiv);
            if(autoScrollEnabled) requestAnimationFrame(()=>terminalDiv.scrollTo({top:terminalDiv.scrollHeight,behavior:'smooth'}));
            return msgDiv;
        }
        function adjustTextareaHeight() {
            userInput.style.height='auto';
            let newHeight = userInput.scrollHeight;
            const maxHeight = 150;
            if(newHeight>maxHeight){newHeight=maxHeight; userInput.style.overflowY='auto';} else userInput.style.overflowY='hidden';
            userInput.style.height = newHeight+'px';
            const inputArea = document.getElementById('inputArea');
            if(inputArea){const inputAreaHeight = inputArea.offsetHeight; const newBottom = `${inputAreaHeight+10}px`;
              tokenCounterDiv.style.bottom = newBottom; scrollToggleDiv.style.bottom=newBottom;}
        }
        function updateTokenCounterUI(){ const count=formatTokenCount(appState.currentTokenCount); const limit=appState.currentTokenLimit!==null?'/'+formatTokenCount(appState.currentTokenLimit):''; tokenCounterDiv.textContent=`Token: \${count}\${limit}`; }
        function updatePromptUI(){ promptSpan.textContent = "> "; }
        function updateUserInteractionState(){ const isDisabled=userInput.placeholder==="Inizializzazione non riuscita. Ricarica la pagina."; userInput.disabled=isDisabled;
            if(appState.isWaitingForAI){userInput.placeholder="Digita 'stop' per interrompere";} 
            else if(isDisabled){} 
            else if(!appState.currentCharacter){userInput.placeholder="Caricamento...";} 
            else {userInput.placeholder="Chiedi all'AI...";} 
            adjustTextareaHeight(); }
        function startThinkingAnimationAndTimer(){ if(!appState.loadingMsgDiv) return;
            const dots=appState.loadingMsgDiv.querySelector('.thinking-dots-span'); const timer=appState.loadingMsgDiv.querySelector('.thinking-timer-span'); if(!dots||!timer) return;
            let dotCount=1; appState.thinkingIntervalId=setInterval(()=>{ dotCount=(dotCount%3)+1; dots.textContent=`Pensando${'.'.repeat(dotCount)}`; },400);
            appState.thinkingStartTime=Date.now(); timer.textContent=`(0.0s)`; appState.timerIntervalId=setInterval(()=>{ const elapsed=Date.now()-appState.thinkingStartTime; timer.textContent=`(${(elapsed/1000).toFixed(1)}s)`; },100);
        }
        function clearThinkingAnimationAndTimer(){ clearInterval(appState.thinkingIntervalId); clearInterval(appState.timerIntervalId); appState.thinkingIntervalId=null; appState.timerIntervalId=null; appState.thinkingStartTime=null; if(appState.loadingMsgDiv){const content=appState.loadingMsgDiv.querySelector('.content'); if(content) content.classList.remove('loading-content'); }}
        function updateStateFromWorkerResponse(data){ if(data.activeCharacter) appState.currentCharacter=data.activeCharacter; if(data.activeModel) appState.currentModel=data.activeModel; if(Array.isArray(data.availableCharacters)) appState.availableCharacters=data.availableCharacters; if(typeof data.tokenCount==='number') appState.currentTokenCount=data.tokenCount; if(typeof data.tokenLimit==='number') appState.currentTokenLimit=data.tokenLimit; updateTokenCounterUI(); updatePromptUI(); }
        function resetConversationState(reason){ appState.conversation=[]; appState.currentTokenCount=0; updateTokenCounterUI(); appendMessage("system","Contesto chat reimpostato ("+reason+"). Nuova conversazione iniziata."); }
        async function callWorkerApi(payload, signal){ let response; try{ response=await fetch(WORKER_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload),signal}); const data=await response.json(); if(!response.ok){ let errMsg=`Errore API ("+response.status+")`; errMsg+=`: ${data?.error||response.statusText}`; console.error(data); const error=new Error(errMsg); error.status=response.status; throw error;} if(!data||(payload.messages&&typeof data.completion!=='string'&&!signal?.aborted)){ throw new Error("Risposta API inattesa."); } updateStateFromWorkerResponse(data); return data;}catch(err){ if(err.name==='AbortError'){ throw err;} if(err instanceof TypeError&&err.message.includes('Failed to fetch')){ const netErr=new Error("Errore di rete. Impossibile raggiungere il worker API."); netErr.status=0; throw netErr;} throw err;} }
        async function handleUserInput(){ const text=userInput.value.trim(); userInput.value=""; adjustTextareaHeight(); if(!text) return;
            if(appState.isWaitingForAI){ if(text.toLowerCase()==='stop'){ appendMessage("user",text); if(appState.abortController){ appState.abortController.abort(); appendMessage("system","Comando di stop ricevuto. Richiesta AI interrotta."); clearThinkingAnimationAndTimer(); if(appState.loadingMsgDiv){appState.loadingMsgDiv.remove(); appState.loadingMsgDiv=null;} appState.isWaitingForAI=false; appState.abortController=null; updateUserInteractionState(); } else appendMessage("error","Nessuna richiesta AI attiva."); } else { appendMessage("user",text); appendMessage("system",`Input "${text}" ignorato: AI occupata. Digita 'stop' per interrompere.`);} return; }
            if(appState.commandHistory.slice(-1)[0]!==text) appState.commandHistory.push(text); appState.historyIndex=appState.commandHistory.length;
            const args=text.toLowerCase().split(/\s+/); const cmd=args[0]; const orig=text.split(/\s+/);
            if(cmd==='reset'){ appendMessage("user",text); resetConversationState('comando utente'); return; }
            if(cmd==='help'){ appendMessage("user",text);
                const sorted=[...COMMAND_INFO].sort((a,b)=>a.name.localeCompare(b.name)); let out="COMANDI:\n";
                sorted.forEach(c=>{out+=`  ${c.desc}\n`;}); out+="\nMODALIT√Ä DISPONIBILI:\n  "; const chars=[...(appState.availableCharacters||[])].sort(); out+=(chars.length?chars.join(', '):'Nessuna')+"\n\nSTATO ATTUALE:\n  Modalit√†: "+(appState.currentCharacter||'N/A')+"\n  Modello:     "+(appState.currentModel||'N/A')+"\n\nCOME CHATTARE:\n  ‚Ä¢ Digita semplicemente qualsiasi testo che non sia un comando per chattare con la modalit√† AI corrente.\n\n";
                appendMessage("system",out,false,"help-output"); return; }
            if(cmd==='set'){ appendMessage("user",text); if(orig.length<3){ appendMessage("error","Uso: imposta modalit√† <nome>"); return;} const type=args[1]; const value=orig.slice(2).join(' ');
                if(type==='character'){ const found=appState.availableCharacters.find(c=>c.toLowerCase()===value.toLowerCase()); if(found){ if(appState.currentCharacter!==found){ appState.currentCharacter=found; appendMessage("system","Modalit√† impostata su: "+found+"."); resetConversationState('cambio modalit√†'); updatePromptUI(); } else appendMessage("system","La modalit√† √® gi√† impostata su: "+found+"."); } else{ const available=appState.availableCharacters.sort((a,b)=>a.localeCompare(b)); appendMessage("error","Modalit√† '"+value+"' non trovata. Disponibili: "+(available.join(',')||'Nessuna')); } } else{ appendMessage("error","Tipo di impostazione sconosciuto. Usa 'modalit√†'."); } return; }
            appendMessage("user",text);
            appState.conversation.push({role:"user",content:text});
            appState.isWaitingForAI=true;
            appState.loadingMsgDiv=appendMessage("assistant","",true);
            startThinkingAnimationAndTimer();
            appState.abortController=new AbortController(); updateUserInteractionState();
            try{
                const payload={messages:appState.conversation,character:appState.currentCharacter,model:appState.currentModel};
                const res=await callWorkerApi(payload,appState.abortController.signal);
                clearThinkingAnimationAndTimer();
                if(appState.loadingMsgDiv&&!appState.abortController.signal.aborted){ const content=appState.loadingMsgDiv.querySelector('.content'); const prefix=appState.loadingMsgDiv.querySelector('.prefix'); if(content&&prefix){ content.classList.remove('loading-content'); prefix.textContent=`\${(appState.currentCharacter||'AI').toUpperCase()}:`; content.textContent=res.completion; } else{ appState.loadingMsgDiv.remove(); appendMessage("assistant",res.completion);} } else if(appState.loadingMsgDiv){ appState.loadingMsgDiv.remove(); }
                appState.loadingMsgDiv=null;
                if(res.completion!==undefined&&!appState.abortController.signal.aborted) appState.conversation.push({role:"assistant",content:res.completion});
                if(appState.currentTokenLimit!==null&&appState.currentTokenCount>=appState.currentTokenLimit){ appendMessage("system","Token limite (\${formatTokenCount(appState.currentTokenLimit)}) raggiunto. Contesto reimpostato automaticamente."); resetConversationState('token limit'); }
            }catch(err){ clearThinkingAnimationAndTimer(); if(appState.loadingMsgDiv){appState.loadingMsgDiv.remove(); appState.loadingMsgDiv=null;} if(err.name!=='AbortError'){ appendMessage("error",err.message||"Si √® verificato un errore.");
                    if(err.status===413||(err.message&&err.message.includes("Token limit reached"))){ appendMessage("system","Messaggio troppo lungo o limite contesto raggiunto. Contesto reimpostato automaticamente."); resetConversationState('input limit'); }
                    userInput.placeholder="Errore. Riprova o usa 'reset'."; }
                appState.isWaitingForAI=false; appState.abortController=null; updateUserInteractionState(); setTimeout(()=>userInput.focus(),50);
            } finally{ adjustTextareaHeight(); }
        }
        function handleKeyDown(e){ if(e.key==="Enter"&&!e.shiftKey&&!userInput.disabled){ e.preventDefault(); handleUserInput(); } else if(e.key==="ArrowUp"&&!userInput.disabled&&userInput.selectionStart===0&&userInput.selectionEnd===0){ if(appState.commandHistory.length>0&&appState.historyIndex>0){ e.preventDefault(); appState.historyIndex--; userInput.value=appState.commandHistory[appState.historyIndex]; requestAnimationFrame(()=>userInput.setSelectionRange(userInput.value.length,userInput.value.length)); adjustTextareaHeight(); } } else if(e.key==="ArrowDown"&&!userInput.disabled&&userInput.selectionStart===userInput.value.length&&userInput.selectionEnd===userInput.value.length){ if(appState.historyIndex<appState.commandHistory.length-1){ e.preventDefault(); appState.historyIndex++; userInput.value=appState.commandHistory[appState.historyIndex]; requestAnimationFrame(()=>userInput.setSelectionRange(userInput.value.length,userInput.value.length)); adjustTextareaHeight(); } else if(appState.historyIndex===appState.commandHistory.length-1){ e.preventDefault(); appState.historyIndex++; userInput.value=""; adjustTextareaHeight(); } } }
        async function initializeApp(){ appendMessage("system","Sessione avviata: "+new Date().toLocaleString()); updateTokenCounterUI(); updatePromptUI(); userInput.placeholder="Inizializzazione in corso..."; userInput.disabled=true; adjustTextareaHeight(); appendMessage("system","Recupero configurazione...");
            try{ await callWorkerApi({type:'init'});
                appendMessage("system","Configurazione caricata."); appendMessage("system","Modalit√†: "+appState.currentCharacter+". Modello: "+appState.currentModel+"."); appendMessage("system","Digita 'help' per i comandi.");
                userInput.disabled=false; updateUserInteractionState(); setTimeout(()=>userInput.focus(),0);
            }catch(err){ appendMessage("error","Inizializzazione non riuscita: "+err.message); appendMessage("system","Impossibile caricare la configurazione. Funzionalit√† limitate. Ricarica la pagina."); userInput.placeholder="Inizializzazione non riuscita. Ricarica la pagina."; userInput.disabled=true; appState.isWaitingForAI=true; }
        }
        userInput.addEventListener("keydown",handleKeyDown);
        userInput.addEventListener("input",adjustTextareaHeight);
        terminalDiv.addEventListener("click",e=>{ if((e.target===terminalDiv||(terminalDiv.contains(e.target)&&e.target.tagName!=='A'))&&window.getSelection().toString()===''&&!appState.isWaitingForAI&&!userInput.disabled){ userInput.focus(); } });
        window.addEventListener("resize",adjustTextareaHeight);
        initializeApp();
    </script>
</body>
</html>
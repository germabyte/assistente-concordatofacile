<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Assistente ConcordatoFacile</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='10 0 100 100'><text y='.9em' font-size='90'>ðŸ¤–</text></svg>" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg-color: #f4f4f9;
      --text-color: #222;
      --input-bg-color: #fff;
      --border-color: #ccc;
      --prompt-color: #007acc;
      --user-prefix-color: #006400;
      --assistant-color: #8b008b;
      --system-color: #666;
      --command-color: #b8860b;
      --error-color: #d00000;
      --highlight-color: #ffc107;
      --scrollbar-thumb-color: #bbb;
      --scrollbar-track-color: #eee;
      --font-family: 'Segoe UI', Roboto, sans-serif;
      --font-size-base: 16px;
      --font-size-mobile: 15px;
      --line-height: 1.6;
      --padding-base: 15px;
      --padding-mobile: 10px;
    }

    *, *::before, *::after {
      box-sizing: border-box;
    }

    html {
      font-size: var(--font-size-base);
    }

    body {
      background-color: var(--bg-color);
      color: var(--text-color);
      font-family: var(--font-family);
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }

    main#terminal {
      flex-grow: 1;
      padding: var(--padding-base);
      overflow-y: auto;
      white-space: pre-wrap;
      line-height: var(--line-height);
    }

    main#terminal::-webkit-scrollbar { width: 10px; }
    main#terminal::-webkit-scrollbar-track { background: var(--scrollbar-track-color); }
    main#terminal::-webkit-scrollbar-thumb { background-color: var(--scrollbar-thumb-color); border-radius: 5px; border: 2px solid var(--scrollbar-track-color); }

    footer#inputArea {
      display: flex;
      background-color: var(--input-bg-color);
      padding: var(--padding-base);
      border-top: 1px solid var(--border-color);
    }

    #prompt {
      color: var(--prompt-color);
      margin-right: 0.5em;
      font-weight: bold;
      line-height: var(--line-height);
      user-select: none;
      align-self: center;
    }

    #userInput {
      flex-grow: 1;
      background-color: transparent;
      border: none;
      outline: none;
      color: var(--text-color);
      font-family: var(--font-family);
      font-size: inherit;
      line-height: var(--line-height);
      resize: none;
      overflow-y: hidden;
    }

    #userInput::placeholder { color: #888; }

    .message {
      margin-bottom: 1em;
      padding: 1em;
      border-radius: 10px;
      background-color: #ffffff;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }

    .user .prefix { color: var(--user-prefix-color); font-weight: bold; }
    .assistant .prefix { color: var(--assistant-color); font-weight: bold; }
    .system .prefix { color: var(--system-color); font-weight: bold; }
    .error .prefix { color: var(--error-color); font-weight: bold; }

    .user .content,
    .assistant .content,
    .system .content,
    .error .content {
      margin-top: 0.5em;
    }

    #tokenCounter {
      position: fixed;
      bottom: 80px;
      right: 20px;
      background: rgba(255, 255, 255, 0.85);
      color: var(--text-color);
      padding: 8px 12px;
      border-radius: 5px;
      border: 1px solid var(--border-color);
      font-size: 14px;
    }

    #scrollToggle {
      position: fixed;
      bottom: 80px;
      left: 20px;
      background: rgba(255, 255, 255, 0.85);
      color: var(--text-color);
      padding: 8px 12px;
      border-radius: 5px;
      border: 1px solid var(--border-color);
      font-size: 14px;
      cursor: pointer;
    }

    .copy-btn {
      display: none;
    }

    @media (max-width: 600px) {
      html { font-size: var(--font-size-mobile); }
      footer#inputArea {
        padding: var(--padding-mobile);
      }
      #tokenCounter, #scrollToggle {
        font-size: 13px;
        padding: 6px 10px;
        bottom: 70px;
      }
    }
  </style>
</head>
<body>
  <main id="terminal"></main>
  <div id="tokenCounter">Token: 0</div>
  <div id="scrollToggle">ðŸ”½ Scorrimento automatico: ATTIVO</div>
  <footer id="inputArea">
    <span id="prompt">></span>
    <textarea id="userInput" rows="1" placeholder="Inizializzazione..." autofocus autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" disabled></textarea>
  </footer>

  <script>
    const COMMAND_INFO = [
      { name: "help", desc: "help   - Mostra questo messaggio di aiuto." },
      { name: "reset", desc: "reset  - Reimposta la conversazione." },
      { name: "imposta modalitÃ ", desc: "imposta modalitÃ  <nome> - Cambia personaggio AI." },
      { name: "stop", desc: "stop   - Interrompe la risposta dell'AI." }
    ];

    function translateCommand(inputText) {
      if (inputText.toLowerCase().startsWith("imposta modalitÃ  ")) {
        return inputText.toLowerCase().replace("imposta modalitÃ ", "set character");
      }
      return inputText;
    }

    const originalHandleUserInput = handleUserInput;
    handleUserInput = async function() {
      const rawText = userInput.value.trim();
      const translated = translateCommand(rawText);
      userInput.value = translated;
      await originalHandleUserInput();
    };

    const originalUpdateUserInteractionState = updateUserInteractionState;
    updateUserInteractionState = function() {
      const isDisabled = userInput.placeholder === "Inizializzazione fallita. Ricarica.";
      userInput.disabled = isDisabled;

      if (appState.isWaitingForAI) {
        userInput.placeholder = `Scrivi 'stop' per interrompere`;
      } else if (isDisabled) {
      } else if (!appState.currentCharacter) {
        userInput.placeholder = "Caricamento configurazione...";
      } else {
        userInput.placeholder = `Scrivi all'AI...`;
      }

      adjustTextareaHeight();
    };

    const originalAppendMessage = appendMessage;
    appendMessage = function(role, text, isLoading = false, extraClass = null, overridePrefix = null) {
      if (role === "system" && extraClass === "help-output") {
        const commandsSorted = [...COMMAND_INFO].sort((a, b) => a.name.localeCompare(b.name));
        let output = "COMANDI DISPONIBILI:\n";
        commandsSorted.forEach(c => output += `  ${c.desc}\n`);
        output += "\nPERSONAGGI DISPONIBILI:\n";
        const chars = [...(appState.availableCharacters || [])].sort((a, b) => a.localeCompare(b));
        output += `  ${chars.length ? chars.join(', ') : 'Nessuno'}\n\n`;
        output += "COME USARE:\n";
        output += "  â€¢ Scrivi qualsiasi cosa per parlare con l'AI.\n\n";
        return originalAppendMessage(role, output, isLoading, extraClass, overridePrefix);
      }

      return originalAppendMessage(role, text, isLoading, extraClass, overridePrefix);
    };
  </script>
</body>
</html>

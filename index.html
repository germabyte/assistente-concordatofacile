<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Assistente ConcordatoFacile</title>
	<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='10 0 100 100'><text y='.9em' font-size='90'>ðŸ¤–</text></svg>">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        /* --- palette, tipografia, layout:Â immutatiÂ --- */
        :root {
          --bg-color: #f8f9fa;
          --text-color: #343a40;
          --input-bg-color: #ffffff;
          --border-color: #dee2e6;

          --prompt-color: #007bff;
          --user-prefix-color: var(--prompt-color);
          --assistant-color: #6f42c1;
          --system-color: #6c757d;
          --command-color: #0056b3;
          --error-color: #dc3545;
          --highlight-color: var(--prompt-color);
          --scrollbar-thumb-color: #ced4da;
          --scrollbar-track-color: #e9ecef;

          --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
          --font-size-base: 17px;
          --font-size-mobile: 16px;
          --line-height: 1.6;

          --padding-base: 18px;
          --padding-mobile: 12px;
          --border-radius-base: 10px;
        }
        *,*::before,*::after{box-sizing:border-box;}

        html{font-size:var(--font-size-base);}
        body{
          background-color:var(--bg-color);
          color:var(--text-color);
          font-family:var(--font-family);
          margin:0;
          padding:0;
          display:flex;
          flex-direction:column;
          height:100vh;height:100dvh;
          overflow:hidden;
        }

        main#terminal{
          flex-grow:1;
		  padding:var(--padding-base) var(--padding-base) 75px var(--padding-base);
          overflow-y:auto;
          white-space:pre-wrap;word-wrap:break-word;
          line-height:var(--line-height);
        }
        main#terminal::-webkit-scrollbar{width:10px;}
        main#terminal::-webkit-scrollbar-track{background:var(--scrollbar-track-color);}
        main#terminal::-webkit-scrollbar-thumb{background-color:var(--scrollbar-thumb-color);border-radius:5px;border:2px solid var(--scrollbar-track-color);}
        main#terminal::-webkit-scrollbar-thumb:hover{background-color:#adb5bd;}
        main#terminal{scrollbar-width:thin;scrollbar-color:var(--scrollbar-thumb-color) var(--scrollbar-track-color);}

        footer#inputArea{
          display:flex;align-items:stretch;
          background-color:var(--input-bg-color);
          padding:calc(var(--padding-base)/1.5) var(--padding-base);
          border-top:1px solid var(--border-color);
          box-shadow:0 -2px 10px rgba(0,0,0,.05);
          flex-shrink:0;position:relative;z-index:10;
        }

        /* --- PULSANTE ALLEGATI (nuovo) --- */
        #attachBtn{
          display:none;                 /* reso visibile solo in modalitÃ  estrazioneâ€‘dati */
          border:none;background:transparent;
          font-size:1.4em;line-height:1;
          cursor:pointer;
          margin-right:8px;
          color:var(--prompt-color);
        }
        #attachBtn:hover{opacity:.7;}

        #tokenCounter{
          position:fixed;bottom:80px;right:20px;
          background-color:rgba(255,255,255,.85);color:var(--text-color);
          padding:6px 12px;border:1px solid var(--border-color);
          border-radius:var(--border-radius-base);
          z-index:1000;font-family:var(--font-family);font-size:14px;
          backdrop-filter:blur(3px);-webkit-backdrop-filter:blur(3px);
          transition:bottom .2s ease-out;
        }

        /* --- messaggi, textarea etc.: inalterati --- */
        .message{position:relative;margin-bottom:calc(var(--padding-base)*.8);display:flex;flex-direction:column;align-items:flex-start;padding:calc(var(--padding-base)/1.2);border-radius:var(--border-radius-base);max-width:95%;}
        .prefix{font-weight:bold;flex-shrink:0;margin-bottom:.3em;user-select:none;white-space:pre;font-size:.9em;opacity:.9;}
        .content{flex-grow:1;word-break:break-word;}
        .user .prefix{color:var(--user-prefix-color);} .user .content{color:var(--text-color);} .user{background-color:rgba(0,123,255,.08);align-self:flex-end;}
        .assistant .prefix{color:var(--assistant-color);} .assistant .content{color:var(--text-color);} .assistant{background-color:rgba(111,66,193,.08);align-self:flex-start;}
        .system .prefix{color:var(--system-color);} .system .content{color:var(--system-color);opacity:.9;} .system{background-color:rgba(108,117,125,.08);font-size:.95em;align-self:center;max-width:90%;text-align:center;}
        .system.help-output{text-align:left;align-self:flex-start;max-width:95%;background-color:rgba(108,117,125,.08);}
        .system.help-output .prefix,.system.help-output .content{color:var(--command-color);opacity:1;}
		.system.help-output .content a{color:var(--assistant-color);text-decoration:underline;}
		.system.help-output code{background-color:rgba(0,0,0,.05);color:var(--text-color);padding:2px 5px;border-radius:4px;font-family:Consolas,Monaco,'Andale Mono','Ubuntu Mono',monospace;font-size:.9em;border:1px solid var(--border-color);}
        .error .prefix{color:var(--error-color);} .error .content{color:var(--error-color);font-weight:bold;} .error{background-color:rgba(220,53,69,.08);align-self:center;text-align:center;max-width:90%;}
        #prompt{color:var(--prompt-color);margin-right:.6em;font-weight:bold;line-height:var(--line-height);padding:calc(var(--padding-base)/2.5) 0;user-select:none;align-self:flex-start;padding-top:10px;}
        #userInput{flex-grow:1;background-color:transparent;border:none;outline:none;color:var(--text-color);font-family:var(--font-family);font-size:inherit;line-height:var(--line-height);padding:calc(var(--padding-base)/2.5) 0;caret-color:var(--prompt-color);resize:none;overflow-y:hidden;min-height:calc(var(--line-height)*1em + (var(--padding-base)/2.5)*2 + 4px);}
        #userInput::placeholder{color:#999;font-style:italic;opacity:.8;} #userInput:disabled{cursor:not-allowed;opacity:.6;}

        .loading-content{display:inline-flex;align-items:baseline;}
        .thinking-timer-span{margin-left:8px;font-size:.9em;opacity:.8;color:var(--system-color);white-space:nowrap;}

        @media (max-width:600px){
          html{font-size:var(--font-size-mobile);}
		  main#terminal{padding:var(--padding-mobile) var(--padding-mobile) 70px var(--padding-mobile);}
          footer#inputArea{padding:calc(var(--padding-mobile)/1.2) var(--padding-mobile);}
          #attachBtn{font-size:1.2em;margin-right:6px;}
          #prompt{padding:calc(var(--padding-mobile)/2) 0;padding-top:8px;}
          #userInput{padding:calc(var(--padding-mobile)/2) 0;min-height:calc(var(--line-height)*1em + var(--padding-mobile));}
          .message{margin-bottom:calc(var(--padding-mobile)*1.2);}
          .message.user,.message.assistant,.message.system,.message.error{padding:calc(var(--padding-mobile)*1.1);}
          main#terminal::-webkit-scrollbar{width:8px;} main#terminal::-webkit-scrollbar-thumb{border-width:1px;}
          #tokenCounter{bottom:70px;right:15px;font-size:13px;padding:5px 10px;}
          .message{max-width:100%;}.system,.error{max-width:95%;}
        }

		/* scroll toggle, copyâ€‘btn: inalterati */

    </style>
</head>
<body>
    <main id="terminal"></main>
    <div id="tokenCounter">Token: 0</div>
	<div id="scrollToggle" class="floatingToggle">ðŸ”½ Scroll Automatico: ON</div>

    <!-- INPUT AREA -->
    <footer id="inputArea">
        <!-- pulsante allegati (visibile solo in modalitÃ  estrazioneâ€‘dati) -->
        <button id="attachBtn" title="Allega file">ðŸ“Ž</button>
        <!-- input file nascosto -->
        <input id="fileUploader" type="file" accept=".pdf,.png,.jpg,.jpeg,image/*,application/pdf" multiple style="display:none;">
        <span id="prompt">></span>
        <textarea id="userInput" rows="1" placeholder="Inizializzazione..." autofocus autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" disabled></textarea>
    </footer>

    <script>
        const WORKER_URL = "https://germabyte-assistente-80.deno.dev/";

		const COMMAND_INFO = [
		  { name: "help", desc: "help - Mostra questo messaggio di aiuto." },
		  { name: "reset", desc: "reset - Reimposta il contesto della chat." },
		  { name: "imposta modalitÃ ", desc: "imposta modalitÃ  &lt;nome&gt; - Cambia la modalitÃ  IA (reimposta contesto)." },
		  { name: "stop", desc: "stop - Interrompe la risposta corrente dell'IA." }
		];

        const terminalDiv   = document.getElementById("terminal");
        const userInput     = document.getElementById("userInput");
        const tokenCounterDiv = document.getElementById("tokenCounter");
        const attachBtn     = document.getElementById("attachBtn");
        const fileUploader  = document.getElementById("fileUploader");

		let autoScrollEnabled = true;
		const scrollToggleDiv = document.getElementById("scrollToggle");
		scrollToggleDiv.addEventListener("click", () => {
		  autoScrollEnabled = !autoScrollEnabled;
		  scrollToggleDiv.textContent = autoScrollEnabled ? "ðŸ”½ Scroll Automatico: ON" : "â¸ï¸ Scroll Automatico: OFF";
		});

        const promptSpan = document.getElementById("prompt");

        const appState = {
            conversation: [],
            commandHistory: [],
            historyIndex: -1,
            isWaitingForAI: false,
            currentCharacter: null,
            currentModel: null,
            availableCharacters: [],
            currentTokenCount: 0,
            currentTokenLimit: null,
            thinkingIntervalId: null,
            timerIntervalId: null,
            thinkingStartTime: null,
            abortController: null,
            loadingMsgDiv: null,
            /* --- nuovi flag per allegati --- */
            pendingFiles: []          // File oggetti in attesa di essere inviati
        };

        /* ---------- HELPER ALLEGATI ---------- */
        function updateAttachmentUI(){
            if (appState.currentCharacter && appState.currentCharacter.toLowerCase()==="estrazione-dati"){
                attachBtn.style.display = "inline-block";
                userInput.placeholder = appState.isWaitingForAI
                    ? `Digita 'stop' per interrompere`
                    : `Scrivi un messaggio o premi ðŸ“Ž per allegare (max 15 file)`;
            }else{
                attachBtn.style.display = "none";
            }
        }
        function fileToDataURL(file){
            return new Promise((resolve,reject)=>{
                const reader=new FileReader();
                reader.onload=()=>resolve(reader.result);
                reader.onerror=reject;
                reader.readAsDataURL(file);
            });
        }
        attachBtn.addEventListener("click",()=>fileUploader.click());
        fileUploader.addEventListener("change",(e)=>{
            const sel=[...e.target.files];
            if (!sel.length) return;
            if (appState.pendingFiles.length + sel.length > 15){
                appendMessage("error", "Ãˆ possibile allegare al massimo 15 file alla volta.");
                fileUploader.value="";
                return;
            }
            sel.forEach(f=>appState.pendingFiles.push(f));
            appendMessage("system", `${sel.length} file aggiunti alla coda (${appState.pendingFiles.length}/15).`);
            fileUploader.value="";
        });

        /* ------------------------------------- */

        function formatTokenCount(num){ if(num===undefined||num===null) return'?'; if(num<1000) return num.toString(); return (num/1000).toFixed(1).replace(/\.0$/,'')+"k";}

        /* appendMessage, scrollToBottom etc. INVARIATI */

        function appendMessage(role,text,isLoading=false,extraClass=null,overridePrefix=null){
            const msgDiv=document.createElement("div");msgDiv.classList.add("message",role);
            if(extraClass)msgDiv.classList.add(extraClass);
            const prefixSpan=document.createElement("span");prefixSpan.classList.add("prefix");
            const contentSpan=document.createElement("span");contentSpan.classList.add("content");
            switch(role){
                case 'user':
                    prefixSpan.textContent="UTENTE:";
                    contentSpan.textContent=text;
                    break;
                case 'assistant':
                    prefixSpan.textContent=overridePrefix ?? `${(appState.currentCharacter||'IA').toUpperCase()}:`;
                    if(isLoading){
                        contentSpan.classList.add("loading-content");
                        contentSpan.innerHTML=`<span class="thinking-dots-span">Sto pensando.</span><span class="thinking-timer-span">(0.0s)</span>`;
                    }else{contentSpan.textContent=text;}
                    break;
				case 'system':
					prefixSpan.textContent="SISTEMA:";
					extraClass==='help-output'?contentSpan.innerHTML=text:contentSpan.textContent=text;
					break;
                case 'error':
                    prefixSpan.textContent="ERRORE!";
                    contentSpan.textContent=text;
                    break;
                default:
                    prefixSpan.textContent="???:";contentSpan.textContent=text;
            }
			msgDiv.appendChild(prefixSpan);msgDiv.appendChild(contentSpan);
			const copyBtn=document.createElement("button");copyBtn.classList.add("copy-btn");copyBtn.setAttribute("title","Copia questo messaggio");copyBtn.textContent="Copia";
			copyBtn.addEventListener("click",(e)=>{e.stopPropagation();const txt=contentSpan.textContent||"";navigator.clipboard.writeText(txt).then(()=>{copyBtn.textContent="Copiato!";setTimeout(()=>copyBtn.textContent="Copia",1500);}).catch(()=>{copyBtn.textContent="Errore";setTimeout(()=>copyBtn.textContent="Copia",1500);});});
			msgDiv.appendChild(copyBtn);
			terminalDiv.appendChild(msgDiv);scrollToBottom();return msgDiv;
		}
        function scrollToBottom(){if(!autoScrollEnabled)return;requestAnimationFrame(()=>{terminalDiv.scrollTo({top:terminalDiv.scrollHeight,behavior:'smooth'});});}

        /* adjustTextareaHeight, start/clear thinking, etc. INVARIATI */

        function updatePromptUI(){promptSpan.textContent="> ";updateAttachmentUI();}
        function updateTokenCounterUI(){const countStr=formatTokenCount(appState.currentTokenCount);const limitStr=formatTokenCount(appState.currentTokenLimit);tokenCounterDiv.textContent=`Token: ${countStr}${appState.currentTokenLimit!==null?'/'+limitStr:''}`;}

        function updateUserInteractionState(){
             const isDisabled=userInput.placeholder==="Inizializzazione fallita. Ricarica.";
             userInput.disabled=isDisabled;
             if(appState.isWaitingForAI){
                 userInput.placeholder=`Digita 'stop' per interrompere`;
             }else if(isDisabled){
                 /* lascia disabled */
             }else if(!appState.currentCharacter){
                 userInput.placeholder="Caricamento config...";
             }else if(appState.currentCharacter.toLowerCase()==="estrazione-dati"){
                 userInput.placeholder=`Scrivi un messaggio o premi ðŸ“Ž per allegare (max 15 file)`;
             }else{
                 userInput.placeholder=`Chiedi all'IA...`;
             }
             adjustTextareaHeight();
        }

        function updateStateFromWorkerResponse(data){
            if(data.activeCharacter) appState.currentCharacter=data.activeCharacter;
            if(data.activeModel)     appState.currentModel=data.activeModel;
            if(data.availableCharacters) appState.availableCharacters=data.availableCharacters;
            if(typeof data.tokenCount==='number') appState.currentTokenCount=data.tokenCount;
            if(typeof data.tokenLimit==='number') appState.currentTokenLimit=data.tokenLimit;
            updateTokenCounterUI();updatePromptUI();
        }

        /* resetConversationState: aggiunto svuota pendingFiles */
        function resetConversationState(reason){
            const reasonMap={'user command':'comando utente','character change':'cambio modalitÃ ','token limit':'limite token','input limit':'limite input'};
            const italianReason=reasonMap[reason]||reason;
            appState.conversation=[];appState.currentTokenCount=0;appState.pendingFiles=[];
            updateTokenCounterUI();
            appendMessage("system",`Contesto chat reimpostato (${italianReason}). Nuova conversazione avviata.`);
            scrollToBottom();
        }

        /* ---------- FUNZIONE PRINCIPALE INPUT UTENTE ---------- */
        async function handleUserInput(){
            let inputText=userInput.value.trim();
            userInput.value="";adjustTextareaHeight();
            /* consente inviare solo file */
            if(inputText==="" && appState.pendingFiles.length===0) return;

            if(appState.isWaitingForAI){
                if(inputText.toLowerCase()==='stop'){appendMessage("user",inputText);
                    if(appState.abortController){appState.abortController.abort();appendMessage("system","Comando stop ricevuto. Richiesta IA interrotta.");clearThinkingAnimationAndTimer();if(appState.loadingMsgDiv){appState.loadingMsgDiv.remove();appState.loadingMsgDiv=null;}appState.isWaitingForAI=false;appState.abortController=null;updateUserInteractionState();}
                    else{appendMessage("error","Impossibile fermare: Nessun processo IA attivo trovato.");}
                }else{
                    appendMessage("user",inputText);appendMessage("system",`Input "${inputText}" ignorato: IA occupata. Digita 'stop' per interrompere.`);
                }scrollToBottom();return;
            }

            /* cronologia comandi â€“ invariata */
            if(appState.commandHistory.length===0||appState.commandHistory[appState.commandHistory.length-1]!==inputText){appState.commandHistory.push(inputText);}
            appState.historyIndex=appState.commandHistory.length;

            /* comandi help/reset ecc.: invariati â€“Â salto al blocco riferimento */
            const commandArgs=inputText.toLowerCase().split(/\s+/);
            const command=commandArgs[0];
            const originalArgs=inputText.split(/\s+/);

            if(command==='reset'){appendMessage("user",inputText);resetConversationState('user command');return;}
            if(command==='help'){appendMessage("user",inputText);
                /* help output unchanged */ /* ... (omesso per brevitÃ , identico al codice precedente) ... */
                const commandsSorted=[...COMMAND_INFO].sort((a,b)=>a.name.localeCompare(b.name,undefined,{sensitivity:"base"}));
                let helpOutput="<b>COMANDI:</b>\n";commandsSorted.forEach(c=>{helpOutput+=`  <code>${c.desc}</code>\n`;});
                helpOutput+="\n<b>MODALITÃ€ DISPONIBILI:</b>\n";
                const chars=[...(appState.availableCharacters||[])].sort((a,b)=>a.localeCompare(b));
                helpOutput+=`  ${chars.length?chars.join(', '):'Nessuna disponibile'}\n\n`;
                helpOutput+="<b>STATO ATTUALE:</b>\n";helpOutput+=`  ModalitÃ : ${appState.currentCharacter||'N/D'}\n`;helpOutput+=`  Modello:  ${appState.currentModel||'N/D'}\n\n`;
                helpOutput+="<b>COME CHATTARE:</b>\n  â€¢ Scrivi semplicemente qualsiasi cosa che non sia un comando per chattare con la modalitÃ  IA corrente.\n\n";
                appendMessage("system",helpOutput,false,"help-output");scrollToBottom();return;
            }
            if(command==='imposta'){appendMessage("user",inputText);
                if(originalArgs.length<3){appendMessage("error","Utilizzo: imposta modalitÃ  <nome>");return;}
                const settingType=commandArgs[1];const settingValue=originalArgs.slice(2).join(' ');
                if(settingType==='modalitÃ '){
                    const characterNameLower=settingValue.toLowerCase();
                    const foundCharacter=appState.availableCharacters.find(c=>c.toLowerCase()===characterNameLower);
                    if(foundCharacter){
                        if(appState.currentCharacter!==foundCharacter){
                            appState.currentCharacter=foundCharacter;appendMessage("system",`ModalitÃ  impostata su: ${appState.currentCharacter}.`);
                            resetConversationState('character change');updatePromptUI();
                        }else{appendMessage("system",`La modalitÃ  Ã¨ giÃ  impostata su: ${appState.currentCharacter}.`);}
                    }else{
                        const sortedChars=[...(appState.availableCharacters||[])].sort((a,b)=>a.localeCompare(b));
                        appendMessage("error",`ModalitÃ  '${settingValue}' non trovata. Disponibili: ${sortedChars.join(', ')||'Nessuna disponibile'}`);
                    }
                }else{appendMessage("error","Tipo di impostazione sconosciuto. Usa 'modalitÃ '.");}
                scrollToBottom();return;
            }

            /* ---------- QUI COSTRUIAMO IL MESSAGGIO DA INVIARE ---------- */
            /* testo visualizzato nel terminale (includo info allegati) */
            const displayText = (inputText || "(documenti inviati)") +
                (appState.pendingFiles.length ? `\n[${appState.pendingFiles.length} allegato/i]` : "");
            appendMessage("user", displayText);

            /* costruiamo content array per OpenRouter */
            let userContentArray=[];
            if(inputText!=="") userContentArray.push({type:"text",text:inputText});

            if(appState.pendingFiles.length){
                /* convertiamo ogni file in base64 â†’ data URL */
                for(const f of appState.pendingFiles){
                    try{
                        const dataURL = await fileToDataURL(f);
                        if(f.type==="application/pdf"){
                            userContentArray.push({type:"file",file:{filename:f.name,file_data:dataURL}});
                        }else{
                            userContentArray.push({type:"image_url",image_url:{url:dataURL}});
                        }
                    }catch(err){
                        appendMessage("error",`Errore lettura file ${f.name}: ${err.message}`); /* continua senza interruzione */
                    }
                }
            }
            /* azzeriamo la coda allegati */
            appState.pendingFiles=[];

            /* aggiungiamo al contesto conversazione */
            appState.conversation.push({role:"user",content:userContentArray.length===1?userContentArray[0].text:userContentArray});
            scrollToBottom();

            /* parte richiesta AI */
            appState.isWaitingForAI=true;
            appState.loadingMsgDiv = appendMessage("assistant","",true);
            startThinkingAnimationAndTimer();
            appState.abortController = new AbortController();
            updateUserInteractionState();

            try{
                const payload={messages:appState.conversation,character:appState.currentCharacter,model:appState.currentModel};
                const result = await callWorkerApi(payload,appState.abortController.signal);

                clearThinkingAnimationAndTimer();

                if(appState.loadingMsgDiv && !appState.abortController.signal.aborted){
                    const contentSpan=appState.loadingMsgDiv.querySelector('.content');
                    const prefixSpan =appState.loadingMsgDiv.querySelector('.prefix');
                    if(contentSpan && prefixSpan){
                        contentSpan.classList.remove('loading-content');
                        prefixSpan.textContent=`${(appState.currentCharacter||'IA').toUpperCase()}:`;
                        contentSpan.textContent=result.completion;
                    }else{
                        appState.loadingMsgDiv.remove();
                        appendMessage("assistant",result.completion);
                    }
                }else if(appState.loadingMsgDiv){appState.loadingMsgDiv.remove();}
                appState.loadingMsgDiv=null;

                if(result.completion!==undefined && !appState.abortController.signal.aborted){
                    appState.conversation.push({role:"assistant",content:result.completion});
                }
                if(appState.currentTokenLimit!==null && appState.currentTokenCount>=appState.currentTokenLimit){
                    appendMessage("system",`Limite token (${formatTokenCount(appState.currentTokenLimit)}) raggiunto. Reimpostazione automatica del contesto.`);
                    resetConversationState('token limit');
                }

            }catch(error){
                clearThinkingAnimationAndTimer();
                if(appState.loadingMsgDiv){appState.loadingMsgDiv.remove();appState.loadingMsgDiv=null;}
                if(error.name!=="AbortError"){
                    appendMessage("error",error.message||"Si Ã¨ verificato un errore sconosciuto.");
                    if(error.status===413 || (error.message && error.message.includes("Token limit reached before processing"))){
                        appendMessage("system","Messaggio di input troppo lungo o limite contesto raggiunto. Reimpostazione automatica del contesto.");
                        resetConversationState('input limit');
                    }
                    if(userInput.placeholder!=="Inizializzazione fallita. Ricarica."){
                        userInput.placeholder=`Errore. Riprova o usa 'reset'. Chiedi all'IA...`;
                    }
                }
                scrollToBottom();
            }finally{
                clearThinkingAnimationAndTimer();
                appState.isWaitingForAI=false;
                appState.abortController=null;
                if(appState.loadingMsgDiv){appState.loadingMsgDiv.remove();appState.loadingMsgDiv=null;}
                if(userInput.placeholder!=="Inizializzazione fallita. Ricarica."){
                    updateUserInteractionState();
                    setTimeout(()=>userInput.focus(),50);
                }
                adjustTextareaHeight();
            }
        }

        /* handleKeyDown: invariato */

        async function initializeApp(){
            appendMessage("system",`Sessione avviata: ${new Date().toLocaleString('it-IT')}`);
            updateTokenCounterUI();updatePromptUI();
            userInput.placeholder="Inizializzazione...";userInput.disabled=true;adjustTextareaHeight();scrollToBottom();
            appendMessage("system","Recupero configurazione...");
            try{
                await callWorkerApi({type:'init'});
                appendMessage("system",`Configurazione caricata.`);
                appendMessage("system",`ModalitÃ : ${appState.currentCharacter}. Modello: ${appState.currentModel}.`);
                appendMessage("system",`Digita 'help' per i comandi.`);
                userInput.disabled=false;appState.isWaitingForAI=false;
                updateUserInteractionState();setTimeout(()=>userInput.focus(),0);
            }catch(error){
                appendMessage("error",`Inizializzazione fallita: ${error.message}`);
                appendMessage("system","Impossibile caricare la configurazione. FunzionalitÃ  limitate. Prova a ricaricare la pagina.");
                userInput.placeholder="Inizializzazione fallita. Ricarica.";userInput.disabled=true;appState.isWaitingForAI=true;
            }finally{scrollToBottom();}
        }

        /* event listeners invariati */
        userInput.addEventListener("keydown",handleKeyDown);
        userInput.addEventListener("input",adjustTextareaHeight);
        terminalDiv.addEventListener('click',(event)=>{if(event.target===terminalDiv||(terminalDiv.contains(event.target)&&event.target.tagName!=='A'&&!event.target.closest('.copy-btn'))){if(window.getSelection().toString()===''&&!appState.isWaitingForAI&&!userInput.disabled){userInput.focus();}}});
        window.addEventListener('resize',adjustTextareaHeight);

        initializeApp();

    </script>
</body>
</html>
